---
import { giscusConfig } from "@/config";

const { class: className } = Astro.props;
---

{giscusConfig.enable && (
    <div class:list={["giscus-container card-base rounded-[var(--radius-large)] px-6 md:px-9 py-8", className]}>
        <div 
            id="giscus-comments"
            class="giscus"
        ></div>
    </div>
)}

<script is:inline define:vars={{ config: giscusConfig }}>
    function loadGiscus() {
        const giscusContainer = document.getElementById('giscus-comments');
        if (!giscusContainer) return;

        // Helper function to get current theme
        function getGiscusTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            return isDark ? 'dark' : 'light';
        }

        // Create and configure the script element
        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.setAttribute('data-repo', config.repo);
        script.setAttribute('data-repo-id', config.repoId);
        script.setAttribute('data-category', config.category);
        script.setAttribute('data-category-id', config.categoryId);
        script.setAttribute('data-mapping', config.mapping);
        script.setAttribute('data-strict', config.strict ? '1' : '0');
        script.setAttribute('data-reactions-enabled', config.reactionsEnabled ? '1' : '0');
        script.setAttribute('data-emit-metadata', config.emitMetadata ? '1' : '0');
        script.setAttribute('data-input-position', config.inputPosition);
        script.setAttribute('data-theme', getGiscusTheme());
        script.setAttribute('data-lang', config.lang);
        script.setAttribute('data-loading', config.loading);
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;

        giscusContainer.appendChild(script);

        // Listen for theme changes and update Giscus theme
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const iframe = document.querySelector('iframe.giscus-frame');
                    if (iframe && iframe.contentWindow) {
                        const theme = getGiscusTheme();
                        iframe.contentWindow.postMessage(
                            { giscus: { setConfig: { theme } } },
                            'https://giscus.app'
                        );
                    }
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Load Giscus when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }
</script>

<style>
    .giscus-container {
        margin-top: 2rem;
    }

    .giscus {
        width: 100%;
    }

    /* Ensure giscus iframe adapts to theme */
    :global(.giscus-frame) {
        width: 100%;
        border: none;
    }
</style>
